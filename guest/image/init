#!/bin/sh
set -eu

CONSOLE="/dev/console"
if [ ! -c "${CONSOLE}" ]; then
  if [ -c /dev/ttyAMA0 ]; then
    CONSOLE="/dev/ttyAMA0"
  elif [ -c /dev/ttyS0 ]; then
    CONSOLE="/dev/ttyS0"
  else
    CONSOLE=""
  fi
fi

log() {
  if [ -n "${CONSOLE}" ]; then
    printf "%s\n" "$*" > "${CONSOLE}" 2>/dev/null || printf "%s\n" "$*"
  else
    printf "%s\n" "$*"
  fi
}

log_cmd() {
  if [ -n "${CONSOLE}" ]; then
    "$@" > "${CONSOLE}" 2>&1 || "$@" || true
  else
    "$@" || true
  fi
}

mount -t proc proc /proc || log "[init] mount proc failed"
mount -t sysfs sysfs /sys || log "[init] mount sysfs failed"
mount -t devtmpfs devtmpfs /dev || log "[init] mount devtmpfs failed"

mkdir -p /dev/pts /dev/shm /run
mount -t devpts devpts /dev/pts || log "[init] mount devpts failed"
mount -t tmpfs tmpfs /run || log "[init] mount tmpfs failed"

export PATH=/usr/sbin:/usr/bin:/sbin:/bin

log "[init] /dev entries:"
log_cmd ls -l /dev
if [ -d /dev/virtio-ports ]; then
  log "[init] /dev/virtio-ports:"
  log_cmd ls -l /dev/virtio-ports
else
  log "[init] /dev/virtio-ports missing"
fi
if [ -d /sys/class/virtio-ports ]; then
  log "[init] /sys/class/virtio-ports:"
  log_cmd ls -l /sys/class/virtio-ports
else
  log "[init] /sys/class/virtio-ports missing"
fi

if modprobe virtio_console > /dev/null 2>&1; then
  log "[init] loaded virtio_console"
fi
if modprobe virtio_rng > /dev/null 2>&1; then
  log "[init] loaded virtio_rng"
fi
if [ -e /dev/hwrng ]; then
  log "[init] starting rngd"
  rngd -r /dev/hwrng -o /dev/random > /dev/null 2>&1 &
else
  log "[init] /dev/hwrng missing"
fi

if modprobe virtio_net > /dev/null 2>&1; then
  log "[init] loaded virtio_net"
fi

if command -v ip > /dev/null 2>&1; then
  ip link set eth0 up || true
else
  ifconfig eth0 up || true
fi

if command -v udhcpc > /dev/null 2>&1; then
  UDHCPC_SCRIPT="/usr/share/udhcpc/default.script"
  if [ ! -x "${UDHCPC_SCRIPT}" ]; then
    UDHCPC_SCRIPT="/sbin/udhcpc.script"
  fi
  if [ -x "${UDHCPC_SCRIPT}" ]; then
    udhcpc -i eth0 -q -n -s "${UDHCPC_SCRIPT}" || log "[init] udhcpc failed"
  else
    udhcpc -i eth0 -q -n || log "[init] udhcpc failed"
  fi
fi

if modprobe fuse > /dev/null 2>&1; then
  log "[init] loaded fuse"
fi

sandboxfs_mount="/data"
sandboxfs_binds=""

if [ -r /proc/cmdline ]; then
  for arg in $(cat /proc/cmdline); do
    case "${arg}" in
      sandboxfs.mount=*)
        sandboxfs_mount="${arg#sandboxfs.mount=}"
        ;;
      sandboxfs.bind=*)
        sandboxfs_binds="${arg#sandboxfs.bind=}"
        ;;
    esac
  done
fi

wait_for_sandboxfs() {
  for i in $(seq 1 50); do
    if grep -q " ${sandboxfs_mount} fuse.sandboxfs " /proc/mounts; then
      return 0
    fi
    sleep 0.1
  done
  return 1
}

mkdir -p "${sandboxfs_mount}"

if [ -x /usr/bin/sandboxfs ]; then
  log "[init] starting sandboxfs at ${sandboxfs_mount}"
  SANDBOXFS_LOG="${CONSOLE:-/dev/null}"
  if [ -z "${SANDBOXFS_LOG}" ]; then
    SANDBOXFS_LOG="/dev/null"
  fi
  /usr/bin/sandboxfs --mount "${sandboxfs_mount}" --rpc-path /dev/virtio-ports/virtio-fs > "${SANDBOXFS_LOG}" 2>&1 &

  if [ -n "${sandboxfs_binds}" ]; then
    if wait_for_sandboxfs; then
      OLD_IFS="${IFS}"
      IFS=","
      for bind in ${sandboxfs_binds}; do
        if [ -z "${bind}" ]; then
          continue
        fi
        mkdir -p "${bind}"
        if [ "${sandboxfs_mount}" = "/" ]; then
          bind_source="${bind}"
        else
          bind_source="${sandboxfs_mount}${bind}"
        fi
        log "[init] binding sandboxfs ${bind_source} -> ${bind}"
        log_cmd mount --bind "${bind_source}" "${bind}"
      done
      IFS="${OLD_IFS}"
    else
      log "[init] sandboxfs mount not ready for bind mounts"
    fi
  fi
fi

log "[init] starting sandboxd"

exec /usr/bin/sandboxd
