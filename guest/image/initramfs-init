#!/bin/sh
set -eu

CONSOLE="/dev/console"
if [ ! -c "${CONSOLE}" ]; then
  if [ -c /dev/ttyAMA0 ]; then
    CONSOLE="/dev/ttyAMA0"
  elif [ -c /dev/ttyS0 ]; then
    CONSOLE="/dev/ttyS0"
  else
    CONSOLE=""
  fi
fi

log() {
  if [ -n "${CONSOLE}" ]; then
    printf "%s\n" "$*" > "${CONSOLE}" 2>/dev/null || printf "%s\n" "$*"
  else
    printf "%s\n" "$*"
  fi
}

mount -t proc proc /proc || log "[initramfs] mount proc failed"
mount -t sysfs sysfs /sys || log "[initramfs] mount sysfs failed"
mount -t devtmpfs devtmpfs /dev || log "[initramfs] mount devtmpfs failed"

mkdir -p /dev/pts /dev/shm /run
mount -t devpts devpts /dev/pts || log "[initramfs] mount devpts failed"
mount -t tmpfs tmpfs /run || log "[initramfs] mount tmpfs failed"

export PATH=/usr/sbin:/usr/bin:/sbin:/bin

root_device="/dev/vda"
root_fstype="ext4"

if [ -r /proc/cmdline ]; then
  for arg in $(cat /proc/cmdline); do
    case "${arg}" in
      root=*)
        root_device="${arg#root=}"
        ;;
      rootfstype=*)
        root_fstype="${arg#rootfstype=}"
        ;;
    esac
  done
fi

modprobe virtio_blk > /dev/null 2>&1 || true
modprobe ext4 > /dev/null 2>&1 || true

for i in $(seq 1 50); do
  if [ -b "${root_device}" ]; then
    break
  fi
  sleep 0.1
done

mkdir -p /newroot
if ! mount -t "${root_fstype}" "${root_device}" /newroot; then
  log "[initramfs] failed to mount ${root_device}"
  exec sh
fi

mkdir -p /newroot/proc /newroot/sys /newroot/dev /newroot/run

exec switch_root /newroot /init
